{"ast":null,"code":"import _toConsumableArray from \"/Users/jh/www/projects/stooge-dnd/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectSpread from \"/Users/jh/www/projects/stooge-dnd/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport filter from 'lodash/filter';\nimport sortBy from 'lodash/sortBy';\nimport find from 'lodash/find';\nimport produce from 'immer'; // import forEach from 'lodash/forEach';\n// import sample from 'lodash/sample';\n\nimport createPersistStateFunction, { getInitialStateFromStorage } from '../utils/persistState';\nimport arrayMove from '../utils/arrayMove';\nimport { TYPE_PLAYER } from './players';\nimport { getAffix, resetAffix } from '../utils/affixes';\nexport var INITIATIVE_MOVE = 'initiative/MOVE';\nexport var INITIATIVE_ADD = 'initiative/ADD';\nexport var INITIATIVE_REMOVE = 'initiative/REMOVE';\nexport var INITIATIVE_TRANSFER_ENCOUNTER = 'initiative/TRANSFER_ENCOUNTER';\nexport var INITIATIVE_INIT_ROLL = 'initiative/INIT_ROLL';\nexport var INITIATIVE_CLEAR_MONSTERS = 'initiative/CLEAR_MONSTERS';\nexport var INITIATIVE_SET_INITIATIVE = 'initiative/SET_INITIATIVE';\nexport var INITIATIVE_TAKE_DAMAGE = 'initiative/TAKE_DAMAGE';\nexport var INITIATIVE_HEAL_DAMAGE = 'initiative/HEAL_DAMAGE';\nvar storageKey = 'stoogeInitiative';\nvar storageVersion = 3;\nvar defaultState = {\n  actors: []\n};\nvar initialState = getInitialStateFromStorage(defaultState, storageKey, storageVersion);\nvar persistState = createPersistStateFunction(storageKey);\n\nfunction moveActors(state, oldIndex, newIndex) {\n  // console.log({ oldIndex, newIndex });\n  var newState = _objectSpread({}, state, {\n    actors: arrayMove(state.actors, oldIndex, newIndex)\n  });\n\n  return persistState(newState);\n}\n\nfunction addActor(state, actor) {\n  if (actor) {\n    var existingActor = find(state.actors, ['name', actor.name]);\n    var enhancedActor = actor;\n\n    if (existingActor) {\n      enhancedActor = _objectSpread({}, actor, {\n        affix: getAffix()\n      });\n    }\n\n    return persistState(_objectSpread({}, state, {\n      actors: sortBy(_toConsumableArray(state.actors).concat([enhancedActor]), ['initiative']).reverse()\n    }));\n  }\n\n  return state;\n}\n\nfunction removeActor(state, actor) {\n  var actors = filter(_toConsumableArray(state.actors), function (stateActor) {\n    return stateActor.id !== actor.id;\n  });\n\n  if (actors.length < state.actors.length) {\n    var newState = _objectSpread({}, state, {\n      actors: actors\n    });\n\n    return persistState(newState);\n  }\n\n  return state;\n}\n\nfunction clearMonsters(state) {\n  var newState = _objectSpread({}, state);\n\n  var actorsWithoutMonster = filter(state.actors, function (actor) {\n    return actor.type === TYPE_PLAYER;\n  });\n  newState.actors = actorsWithoutMonster;\n  resetAffix();\n  return persistState(newState);\n}\n\nfunction setActorInitiative(state, actor, initiative) {\n  var actorIndex = state.actors.indexOf(actor);\n\n  if (actorIndex !== -1) {\n    var newActors = filter(state.actors, function (stateActor) {\n      return stateActor.id !== actor.id;\n    });\n    newActors.push(_objectSpread({}, actor, {\n      initiative: initiative\n    }));\n\n    var newState = _objectSpread({}, state, {\n      actors: sortBy(newActors, ['initiative']).reverse()\n    });\n\n    return persistState(newState);\n  }\n\n  return state;\n}\n\nfunction takeDamage(state, actor, damage) {\n  var actorIndex = state.actors.indexOf(actor);\n\n  if (actorIndex !== -1 && damage) {\n    var damagedActor = _objectSpread({}, actor, {\n      currentHP: actor.currentHP - damage\n    });\n\n    var newState = _objectSpread({}, state);\n\n    newState.actors[actorIndex] = damagedActor;\n    return persistState(newState);\n  }\n\n  return state;\n}\n\nfunction healDamage(state, actor, heal) {\n  return takeDamage(state, actor, -heal);\n}\n\nexport default (function () {\n  var state = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : initialState;\n  var action = arguments.length > 1 ? arguments[1] : undefined;\n\n  switch (action.type) {\n    case INITIATIVE_ADD:\n      return addActor(state, action.actor);\n\n    case INITIATIVE_REMOVE:\n      return removeActor(state, action.actor);\n\n    case INITIATIVE_MOVE:\n      return moveActors(state, action.oldIndex, action.newIndex);\n\n    case INITIATIVE_CLEAR_MONSTERS:\n      return clearMonsters(state);\n\n    case INITIATIVE_SET_INITIATIVE:\n      return setActorInitiative(state, action.actor, action.initiative);\n\n    case INITIATIVE_TAKE_DAMAGE:\n      return takeDamage(state, action.actor, Math.abs(action.damage));\n\n    case INITIATIVE_HEAL_DAMAGE:\n      return healDamage(state, action.actor, Math.abs(action.heal));\n\n    default:\n      return state;\n  }\n});","map":{"version":3,"sources":["/Users/jh/www/projects/stooge-dnd/src/reducers/initiative.js"],"names":["filter","sortBy","find","produce","createPersistStateFunction","getInitialStateFromStorage","arrayMove","TYPE_PLAYER","getAffix","resetAffix","INITIATIVE_MOVE","INITIATIVE_ADD","INITIATIVE_REMOVE","INITIATIVE_TRANSFER_ENCOUNTER","INITIATIVE_INIT_ROLL","INITIATIVE_CLEAR_MONSTERS","INITIATIVE_SET_INITIATIVE","INITIATIVE_TAKE_DAMAGE","INITIATIVE_HEAL_DAMAGE","storageKey","storageVersion","defaultState","actors","initialState","persistState","moveActors","state","oldIndex","newIndex","newState","addActor","actor","existingActor","name","enhancedActor","affix","reverse","removeActor","stateActor","id","length","clearMonsters","actorsWithoutMonster","type","setActorInitiative","initiative","actorIndex","indexOf","newActors","push","takeDamage","damage","damagedActor","currentHP","healDamage","heal","action","Math","abs"],"mappings":"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","sourcesContent":["import filter from 'lodash/filter';\nimport sortBy from 'lodash/sortBy';\nimport find from 'lodash/find';\nimport produce from 'immer';\n// import forEach from 'lodash/forEach';\n// import sample from 'lodash/sample';\n\nimport createPersistStateFunction, {\n\tgetInitialStateFromStorage,\n} from '../utils/persistState';\nimport arrayMove from '../utils/arrayMove';\nimport { TYPE_PLAYER } from './players';\nimport { getAffix, resetAffix } from '../utils/affixes';\n\nexport const INITIATIVE_MOVE = 'initiative/MOVE';\nexport const INITIATIVE_ADD = 'initiative/ADD';\nexport const INITIATIVE_REMOVE = 'initiative/REMOVE';\nexport const INITIATIVE_TRANSFER_ENCOUNTER = 'initiative/TRANSFER_ENCOUNTER';\nexport const INITIATIVE_INIT_ROLL = 'initiative/INIT_ROLL';\nexport const INITIATIVE_CLEAR_MONSTERS = 'initiative/CLEAR_MONSTERS';\nexport const INITIATIVE_SET_INITIATIVE = 'initiative/SET_INITIATIVE';\nexport const INITIATIVE_TAKE_DAMAGE = 'initiative/TAKE_DAMAGE';\nexport const INITIATIVE_HEAL_DAMAGE = 'initiative/HEAL_DAMAGE';\n\nconst storageKey = 'stoogeInitiative';\nconst storageVersion = 3;\nconst defaultState = {\n\tactors: [],\n};\nconst initialState = getInitialStateFromStorage(\n\tdefaultState,\n\tstorageKey,\n\tstorageVersion,\n);\nconst persistState = createPersistStateFunction(storageKey);\n\nfunction moveActors(state, oldIndex, newIndex) {\n\t// console.log({ oldIndex, newIndex });\n\tconst newState = {\n\t\t...state,\n\t\tactors: arrayMove(state.actors, oldIndex, newIndex),\n\t};\n\n\treturn persistState(newState);\n}\n\nfunction addActor(state, actor) {\n\tif (actor) {\n\t\tconst existingActor = find(state.actors, ['name', actor.name]);\n\t\tlet enhancedActor = actor;\n\t\tif (existingActor) {\n\t\t\tenhancedActor = {\n\t\t\t\t...actor,\n\t\t\t\taffix: getAffix(),\n\t\t\t};\n\t\t}\n\n\t\treturn persistState({\n\t\t\t...state,\n\t\t\tactors: sortBy(\n\t\t\t\t[...state.actors, enhancedActor],\n\t\t\t\t['initiative'],\n\t\t\t).reverse(),\n\t\t});\n\t}\n\n\treturn state;\n}\n\nfunction removeActor(state, actor) {\n\tconst actors = filter(\n\t\t[...state.actors],\n\t\t(stateActor) => stateActor.id !== actor.id,\n\t);\n\tif (actors.length < state.actors.length) {\n\t\tconst newState = {\n\t\t\t...state,\n\t\t\tactors,\n\t\t};\n\n\t\treturn persistState(newState);\n\t}\n\n\treturn state;\n}\n\nfunction clearMonsters(state) {\n\tconst newState = { ...state };\n\tconst actorsWithoutMonster = filter(\n\t\tstate.actors,\n\t\t(actor) => actor.type === TYPE_PLAYER,\n\t);\n\n\tnewState.actors = actorsWithoutMonster;\n\tresetAffix();\n\n\treturn persistState(newState);\n}\n\nfunction setActorInitiative(state, actor, initiative) {\n\tconst actorIndex = state.actors.indexOf(actor);\n\tif (actorIndex !== -1) {\n\t\tconst newActors = filter(\n\t\t\tstate.actors,\n\t\t\t(stateActor) => stateActor.id !== actor.id,\n\t\t);\n\n\t\tnewActors.push({\n\t\t\t...actor,\n\t\t\tinitiative,\n\t\t});\n\n\t\tconst newState = {\n\t\t\t...state,\n\t\t\tactors: sortBy(newActors, ['initiative']).reverse(),\n\t\t};\n\n\t\treturn persistState(newState);\n\t}\n\n\treturn state;\n}\n\nfunction takeDamage(state, actor, damage) {\n\tconst actorIndex = state.actors.indexOf(actor);\n\tif (actorIndex !== -1 && damage) {\n\t\tconst damagedActor = {\n\t\t\t...actor,\n\t\t\tcurrentHP: actor.currentHP - damage,\n\t\t};\n\n\t\tconst newState = { ...state };\n\t\tnewState.actors[actorIndex] = damagedActor;\n\n\t\treturn persistState(newState);\n\t}\n\n\treturn state;\n}\n\nfunction healDamage(state, actor, heal) {\n\treturn takeDamage(state, actor, -heal);\n}\n\nexport default (state = initialState, action) => {\n\tswitch (action.type) {\n\t\tcase INITIATIVE_ADD:\n\t\t\treturn addActor(state, action.actor);\n\t\tcase INITIATIVE_REMOVE:\n\t\t\treturn removeActor(state, action.actor);\n\t\tcase INITIATIVE_MOVE:\n\t\t\treturn moveActors(state, action.oldIndex, action.newIndex);\n\t\tcase INITIATIVE_CLEAR_MONSTERS:\n\t\t\treturn clearMonsters(state);\n\t\tcase INITIATIVE_SET_INITIATIVE:\n\t\t\treturn setActorInitiative(state, action.actor, action.initiative);\n\t\tcase INITIATIVE_TAKE_DAMAGE:\n\t\t\treturn takeDamage(state, action.actor, Math.abs(action.damage));\n\t\tcase INITIATIVE_HEAL_DAMAGE:\n\t\t\treturn healDamage(state, action.actor, Math.abs(action.heal));\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n"]},"metadata":{},"sourceType":"module"}